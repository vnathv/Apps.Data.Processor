variables:
  BuildConfiguration: 'release'
  BuildPlatform: 'any cpu'
  SolutionName: 'Apps.Data.Processor'
  ProjectName: 'Apps.Data.Processor'
  Subject: 'AppsDataProcessor'
  TestCategory: 'CI'

# Clear Before Build
resources:
- repo: self
  clean: true

steps:
# GitVersion
- task: gittools.gitversion.gitversion-task.GitVersion@5
  displayName: GitVersion
  inputs:
    updateAssemblyInfo: false

#Install .NET SDK 6.0.x
- task: UseDotNet@2
  displayName: 'Use .NET SDK 6.0.x'
  inputs:
      packageType: sdk
      version: 6.0.x
      installationPath: $(Agent.ToolsDirectory)/dotnet

# Restore
- task: DotNetCoreCLI@2
  displayName: Nuget restore
  inputs:
    command: 'restore'
    feedsToUse: config
    nugetConfigPath: NuGet.config

# Build
- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: 'build'
    configuration: '$(BuildConfiguration)'
    arguments: '-p:Version=$(GitVersion.NugetVersionV2) -c $(BuildConfiguration) --no-restore'

#copy Bicep Files
- task: CopyFiles@2
  displayName: 'Copy ServiceBusTopicSubscription.json'
  inputs:
    sourceFolder: '.'
    contents: '*.bicep'
    targetFolder: '$(Build.ArtifactStagingDirectory)\$(Subject)'

# Publish
- task: DotNetCoreCLI@2
  displayName: 'Publish'
  inputs:
    command: 'publish'
    publishWebProjects: false
    zipAfterPublish: false
    solution: src/$(ProjectName)/$(ProjectName).csproj
    arguments: '-o "$(Build.ArtifactStagingDirectory)\$(Subject)" /p:Version=$(GitVersion.NugetVersionV2) -c $(BuildConfiguration)'

# Publish Artifacts
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\$(Subject)'

# Clean Agent Directories
- task: mspremier.PostBuildCleanup.PostBuildCleanup-task.PostBuildCleanup@3
  displayName: 'Clean Agent Directories'
  condition: always()
